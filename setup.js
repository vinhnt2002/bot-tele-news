#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const readline = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

console.log('ğŸš€ Twitter Telegram Bot Setup Script');
console.log('=====================================\n');

const questions = [
  {
    key: 'TELEGRAM_BOT_TOKEN',
    question: 'Nháº­p Telegram Bot Token (tá»« @BotFather): ',
    required: true
  },
  {
    key: 'TELEGRAM_CHAT_ID',
    question: 'Nháº­p Telegram Chat ID (tá»« @userinfobot): ',
    required: true
  },
  {
    key: 'TWITTER_API_KEY',
    question: 'Nháº­p Twitter API Key (tá»« twitterapi.io): ',
    required: true
  },
  {
    key: 'MONGODB_URI',
    question: 'Nháº­p MongoDB URI [mongodb://localhost:27017/twitter-telegram-bot]: ',
    required: false,
    default: 'mongodb://localhost:27017/twitter-telegram-bot'
  },
  {
    key: 'CHECK_INTERVAL_MINUTES',
    question: 'Thá»i gian kiá»ƒm tra tweets (phÃºt) [5]: ',
    required: false,
    default: '5'
  }
];

async function askQuestion(question) {
  return new Promise((resolve) => {
    rl.question(question.question, (answer) => {
      if (!answer && question.required) {
        console.log('âŒ TrÆ°á»ng nÃ y lÃ  báº¯t buá»™c!');
        return askQuestion(question).then(resolve);
      }
      resolve(answer || question.default || '');
    });
  });
}

async function setupBot() {
  try {
    const config = {};
    
    console.log('Vui lÃ²ng nháº­p thÃ´ng tin cáº¥u hÃ¬nh:\n');
    
    for (const question of questions) {
      config[question.key] = await askQuestion(question);
    }
    
    // Táº¡o ná»™i dung file .env
    let envContent = '# Twitter Telegram Bot Configuration\n';
    envContent += '# Generated by setup script\n\n';
    
    for (const [key, value] of Object.entries(config)) {
      envContent += `${key}=${value}\n`;
    }
    
    envContent += '\n# Application Settings\n';
    envContent += 'NODE_ENV=development\n';
    envContent += 'PORT=3000\n';
    
    // Kiá»ƒm tra náº¿u file .env Ä‘Ã£ tá»“n táº¡i
    const envPath = path.join(__dirname, '.env');
    if (fs.existsSync(envPath)) {
      const backup = await new Promise((resolve) => {
        rl.question('\nâš ï¸  File .env Ä‘Ã£ tá»“n táº¡i. Táº¡o backup? (y/n): ', resolve);
      });
      
      if (backup.toLowerCase() === 'y') {
        const backupPath = `${envPath}.backup.${Date.now()}`;
        fs.copyFileSync(envPath, backupPath);
        console.log(`âœ… ÄÃ£ táº¡o backup: ${backupPath}`);
      }
    }
    
    // Ghi file .env
    fs.writeFileSync(envPath, envContent);
    console.log('\nâœ… ÄÃ£ táº¡o file .env thÃ nh cÃ´ng!');
    
    // Táº¡o thÆ° má»¥c logs
    const logsDir = path.join(__dirname, 'logs');
    if (!fs.existsSync(logsDir)) {
      fs.mkdirSync(logsDir, { recursive: true });
      console.log('âœ… ÄÃ£ táº¡o thÆ° má»¥c logs');
    }
    
    console.log('\nğŸ‰ Setup hoÃ n táº¥t!');
    console.log('\nCÃ¡c bÆ°á»›c tiáº¿p theo:');
    console.log('1. CÃ i Ä‘áº·t dependencies: npm install');
    console.log('2. Khá»Ÿi Ä‘á»™ng bot: npm start');
    console.log('3. Hoáº·c development mode: npm run dev');
    console.log('\nğŸ“– Xem README.md Ä‘á»ƒ biáº¿t thÃªm chi tiáº¿t!');
    
  } catch (error) {
    console.error('âŒ Lá»—i setup:', error.message);
  } finally {
    rl.close();
  }
}

setupBot(); 